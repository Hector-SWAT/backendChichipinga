<?php
header("Access-Control-Allow-Origin: *"); 
header("Content-Type: application/json");
header("Access-Control-Allow-Methods: POST, GET, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type");

// Manejar preflight requests
if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
    exit(0);
}

// Leer API Key de Google Gemini desde variable de entorno
$apiKey = getenv('GEMINI_API_KEY');

if (!$apiKey) {
    echo json_encode(["reply" => "El restaurante La Chichipinga te responde: Error de configuraci√≥n del servicio."]);
    exit;
}

// Leer el mensaje del usuario
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $input = json_decode(file_get_contents('php://input'), true);
    $userMessage = $input['message'] ?? "Hola";
} else {
    $userMessage = $_GET['message'] ?? "Hola";
}

// Sistema de respuestas predefinidas como fallback
function getPredefinedResponse($userMessage) {
    $message = strtolower(trim($userMessage));
    
    // Respuestas predefinidas
    $responses = [
        'hola' => 'El restaurante La Chichipinga te responde: ¬°Hola! Bienvenido a nuestro restaurante mexicano. ¬øEn qu√© puedo ayudarte hoy?',
        
        'menu' => 'El restaurante La Chichipinga te ofrece: 
üç≤ ESPECIALIDADES: 
- Tacos al Pastor ($50)
- Enchiladas Verdes ($90) 
- Mole Poblano ($120)
- Pasta Especial ($110)
- Pizza Especial ($150)

ü•ó MEN√ö EJECUTIVO:
- Men√∫ del D√≠a ($80)
- Ejecutivo Ligero ($70)

üë®‚Äçüë©‚Äçüëß PROMOCIONES:
- Promo Familiar ($300)
- Combo Pareja ($120)

‚òï CAF√â Y POSTRE:
- Tiramis√∫ ($80)
- Caf√© Premium ($50)
- Flan Napolitano ($60)
- Pan de Elote ($70)',
        
        'tacos' => 'El restaurante La Chichipinga te ofrece: Tacos al Pastor con pi√±a, salsa picante y carne de cerdo por $50. ¬°Nuestra especialidad de la casa!',
        
        'horario' => 'El restaurante La Chichipinga te responde: 
üìÖ Lunes a Viernes: 9:00 am ‚Äì 6:00 pm
üìÖ S√°bados y Domingos: 9:00 am ‚Äì 8:00 pm',
        
        'ubicacion' => 'El restaurante La Chichipinga te responde: Estamos ubicados en Jos√© Dolores P√©rez #3, andador de los Jilgueros, Zacatl√°n, Puebla. ¬°Te esperamos! üó∫Ô∏è',
        
        'precio' => 'El restaurante La Chichipinga te ofrece: Nuestros precios van desde $50 por los Tacos al Pastor hasta $150 por la Pizza Especial. Tenemos opciones para todos los presupuestos.',
        
        'promociones' => 'El restaurante La Chichipinga te ofrece: 
üë®‚Äçüë©‚Äçüëß PROMO FAMILIAR ($300) - 2 platos principales + 2 entradas + postre grande
üíë COMBO PAREJA ($120) - 2 tacos + 2 bebidas + 1 postre peque√±o
üéâ MEN√ö EJECUTIVO ($80) - Plato principal + entrada + postre + bebida',
        
        'recomendacion' => 'El restaurante La Chichipinga te ofrece: Te recomendamos nuestros famosos Tacos al Pastor si buscas algo tradicional, o el Mole Poblano si quieres probar un platillo emblem√°tico de Puebla. ¬°Ambos son excelentes!',
        
        'vegetariano' => 'El restaurante La Chichipinga te ofrece: Tenemos opciones vegetarianas como las Enchiladas Verdes (sin pollo), Pasta Especial y Pizza Especial. Tambi√©n ofrecemos el Men√∫ Ejecutivo Ligero con opciones saludables.',
        
        'postres' => 'El restaurante La Chichipinga te ofrece: 
üç∞ Tiramis√∫ Cl√°sico - $80
‚òï Caf√© Premium - $50
üçÆ Flan Napolitano - $60
üåΩ Pan de Elote - $70',
        
        'bebidas' => 'El restaurante La Chichipinga te ofrece: 
ü•§ Refrescos ($25)
üíß Aguas frescas ($30)
‚òï Caf√© Premium ($50)
üç∫ Cervezas ($40)
üç∑ Vino de la casa ($60)',
        
        'reservacion' => 'El restaurante La Chichipinga te responde: Para reservaciones puedes llamarnos al 123-456-7890. Recomendamos reservar con anticipaci√≥n los fines de semana.',
        
        'delivery' => 'El restaurante La Chichipinga te responde: S√≠, hacemos delivery en Zacatl√°n y √°reas cercanas. Ll√°manos al 123-456-7890 para realizar tu pedido.',
        
        'estacionamiento' => 'El restaurante La Chichipinga te responde: Contamos con estacionamiento gratuito para nuestros clientes.',
        
        'especial' => 'El restaurante La Chichipinga te ofrece: Nuestro platillo m√°s especial es el Mole Poblano, una receta tradicional de Puebla con m√°s de 20 ingredientes. ¬°Una verdadera experiencia culinaria!',
        
        'popular' => 'El restaurante La Chichipinga te ofrece: Nuestros Tacos al Pastor son los m√°s populares, seguidos del Mole Poblano y la Pizza Especial. ¬°Todos son deliciosos!',
        
        'picante' => 'El restaurante La Chichipinga te ofrece: Si te gusta lo picante, te recomendamos los Tacos al Pastor con nuestra salsa picante especial o las Enchiladas Verdes. ¬°Tenemos diferentes niveles de picor!',
        
        'familiar' => 'El restaurante La Chichipinga te responde: Somos un restaurante familiar con ambiente acogedor. Tenemos √°rea para ni√±os y la Promo Familiar perfecta para compartir.',
        
        'eventos' => 'El restaurante La Chichipinga te responde: S√≠, organizamos eventos especiales. Contamos con espacio para celebraciones. Cont√°ctanos para m√°s informaci√≥n.',
        
        'pago' => 'El restaurante La Chichipinga te responde: Aceptamos efectivo, tarjetas de cr√©dito/d√©bito y transferencias bancarias.',
        
        'wifi' => 'El restaurante La Chichipinga te responde: S√≠, ofrecemos WiFi gratuito a nuestros clientes.'
    ];
    
    // Buscar coincidencias en el mensaje
    foreach ($responses as $key => $response) {
        if (strpos($message, $key) !== false) {
            return $response;
        }
    }
    
    // B√∫squeda por patrones mejorada
    if (strpos($message, 'menu') !== false || strpos($message, 'plato') !== false || strpos($message, 'comida') !== false || strpos($message, 'qu√© tienen') !== false || strpos($message, 'carta') !== false) {
        return $responses['menu'];
    }
    
    if (strpos($message, 'hora') !== false || strpos($message, 'cu√°ndo') !== false || strpos($message, 'abren') !== false || strpos($message, 'cierran') !== false) {
        return $responses['horario'];
    }
    
    if (strpos($message, 'd√≥nde') !== false || strpos($message, 'ubicacion') !== false || strpos($message, 'direccion') !== false || strpos($message, 'local') !== false) {
        return $responses['ubicacion'];
    }
    
    if (strpos($message, 'promo') !== false || strpos($message, 'ofert') !== false || strpos($message, 'combo') !== false || strpos($message, 'descuento') !== false) {
        return $responses['promociones'];
    }
    
    if (strpos($message, 'recomienda') !== false || strpos($message, 'recomendaci√≥n') !== false || strpos($message, 'sugerencia') !== false) {
        return $responses['recomendacion'];
    }
    
    if (strpos($message, 'vegetariano') !== false || strpos($message, 'vegano') !== false || strpos($message, 'sin carne') !== false) {
        return $responses['vegetariano'];
    }
    
    if (strpos($message, 'postre') !== false || strpos($message, 'dulce') !== false || strpos($message, 'postres') !== false) {
        return $responses['postres'];
    }
    
    if (strpos($message, 'bebida') !== false || strpos($message, 'refresco') !== false || strpos($message, 'cerveza') !== false || strpos($message, 'vino') !== false) {
        return $responses['bebidas'];
    }
    
    if (strpos($message, 'reserva') !== false || strpos($message, 'reservar') !== false || strpos($message, 'mesa') !== false) {
        return $responses['reservacion'];
    }
    
    if (strpos($message, 'delivery') !== false || strpos($message, 'domicilio') !== false || strpos($message, 'a domicilio') !== false || strpos($message, 'entrega') !== false) {
        return $responses['delivery'];
    }
    
    if (strpos($message, 'estacionamiento') !== false || strpos($message, 'parqueo') !== false || strpos($message, 'aparcar') !== false) {
        return $responses['estacionamiento'];
    }
    
    if (strpos($message, 'especial') !== false || strpos($message, 'especialidad') !== false || strpos($message, 'famoso') !== false) {
        return $responses['especial'];
    }
    
    if (strpos($message, 'popular') !== false || strpos($message, 'm√°s pedido') !== false || strpos($message, 'favorito') !== false) {
        return $responses['popular'];
    }
    
    if (strpos($message, 'picante') !== false || strpos($message, 'picoso') !== false) {
        return $responses['picante'];
    }
    
    if (strpos($message, 'familiar') !== false || strpos($message, 'ni√±os') !== false || strpos($message, 'infantil') !== false) {
        return $responses['familiar'];
    }
    
    if (strpos($message, 'evento') !== false || strpos($message, 'fiesta') !== false || strpos($message, 'celebraci√≥n') !== false) {
        return $responses['eventos'];
    }
    
    if (strpos($message, 'pago') !== false || strpos($message, 'tarjeta') !== false || strpos($message, 'efectivo') !== false || strpos($message, 'pagar') !== false) {
        return $responses['pago'];
    }
    
    if (strpos($message, 'wifi') !== false || strpos($message, 'internet') !== false) {
        return $responses['wifi'];
    }
    
    // Respuesta por defecto mejorada
    return 'El restaurante La Chichipinga te responde: ¬°Hola! Somos un restaurante mexicano tradicional en Zacatl√°n, Puebla. ¬øTe interesa conocer nuestro men√∫, horarios, promociones, hacer una reservaci√≥n o tienes alguna pregunta espec√≠fica?';
}

// Usar Google Gemini API
$ch = curl_init("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" . $apiKey);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    "Content-Type: application/json"
]);

// Prompt mejorado para Gemini
$systemPrompt = "Eres el asistente oficial del restaurante La Chichipinga, un restaurante tradicional mexicano ubicado en Zacatl√°n, Puebla. Siempre responde en espa√±ol, de forma breve, amable y clara.

Reglas obligatorias:
- Si la pregunta es sobre platillos, men√∫, recomendaciones o comida ‚Üí comienza con: 'El restaurante La Chichipinga te ofrece...'
- Si la pregunta es sobre horarios, ubicaci√≥n, reservaciones, delivery u otra informaci√≥n del restaurante ‚Üí comienza con: 'El restaurante La Chichipinga te responde...'

INFORMACI√ìN DEL RESTAURANTE:
üìç UBICACI√ìN: Jos√© Dolores P√©rez #3, andador de los Jilgueros, Zacatl√°n, Puebla
üìû TEL√âFONO: 123-456-7890

üç≤ ESPECIALIDADES:
- Tacos al Pastor ‚Äî $50 (nuestra especialidad)
- Enchiladas Verdes ‚Äî $90  
- Mole Poblano ‚Äî $120 (platillo emblem√°tico)
- Pasta Especial ‚Äî $110
- Pizza Especial ‚Äî $150

ü•ó MEN√ö EJECUTIVO:
- Men√∫ del D√≠a: $80 (plato principal + entrada + postre + bebida)
- Ejecutivo Ligero: $70 (opci√≥n saludable)

üë®‚Äçüë©‚Äçüëß PROMOCIONES:
- Promo Familiar ‚Äî $300 (2 platos principales + 2 entradas + postre grande)
- Combo Pareja ‚Äî $120 (2 tacos + 2 bebidas + 1 postre peque√±o)

‚òï CAF√â Y POSTRE:
- Tiramis√∫ Cl√°sico ‚Äî $80
- Caf√© Premium ‚Äî $50
- Flan Napolitano ‚Äî $60
- Pan de Elote ‚Äî $70

ü•§ BEBIDAS:
- Refrescos ‚Äî $25
- Aguas frescas ‚Äî $30
- Cervezas ‚Äî $40
- Vino de la casa ‚Äî $60

üìÖ HORARIOS:
- Lunes a Viernes: 9:00 am ‚Äì 6:00 pm
- S√°bados y Domingos: 9:00 am ‚Äì 8:00 pm

SERVICIOS:
‚úÖ Delivery en Zacatl√°n
‚úÖ Reservaciones
‚úÖ Estacionamiento gratuito
‚úÖ WiFi gratuito
‚úÖ Eventos y celebraciones
‚úÖ Opciones vegetarianas

Responde de forma muy breve y directa (m√°ximo 2-3 l√≠neas), siendo amable y servicial.";

$data = [
    "contents" => [
        [
            "parts" => [
                [
                    "text" => $systemPrompt . "\n\nEl cliente dice: \"" . $userMessage . "\""
                ]
            ]
        ]
    ],
    "generationConfig" => [
        "temperature" => 0.7,
        "maxOutputTokens" => 300,
        "topP" => 0.8,
        "topK" => 40
    ]
];

curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));

$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$curlError = curl_error($ch);
curl_close($ch);

// Procesar respuesta
$reply = getPredefinedResponse($userMessage); // Fallback por defecto

if ($response !== false) {
    $result = json_decode($response, true);
    
    if (isset($result['candidates'][0]['content']['parts'][0]['text'])) {
        $reply = $result['candidates'][0]['content']['parts'][0]['text'];
    } else {
        // Si hay error con Gemini, usar respuestas predefinidas
        error_log("Error Gemini: " . json_encode($result));
    }
}

// Limpiar respuesta y asegurar formato
$reply = trim($reply);
if (empty($reply)) {
    $reply = getPredefinedResponse($userMessage);
}

// Devolver JSON
echo json_encode(["reply" => $reply]);
?>